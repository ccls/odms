<% require 'csv' -%>
<%# 
	adding :headers => true is supposed to set a flag in the file 
	somewhere marking it as having a header row, but I don't 
	think that it actually does.

	also, use a - with the ruby closing tag to avoid extra lines in csv file.
-%>
<%= %w( 
    reference_date
    icf_master_id
    mom_icfmasterid
    mother_first_name
    mother_maiden_name
    mother_last_name
    father_first_name
    father_last_name
    first_name
    middle_name
    last_name
    dob
    sex
    vital_status
    do_not_contact
    is_eligible
    consented
    comments
    language
    street
    unit
    city
    state
    zip
    county
    phone
    alternate_phone
).to_csv( :headers => true) -%>
<% @controls.each do |control| -%>
<% mom = control.mother -%>
<% address = control.addresses.first -%>
<%# Do I need to check if current_address==true? -%>
<% enrollment = control.enrollments.find_by_project_id(Project['ccls'].id) -%>
<%= [
mdy_or_nil(control.reference_date),
control.icf_master_id_to_s,
mom.try(:icf_master_id_to_s)||"[No Mother Subject]",
control.mother_first_name,
control.mother_maiden_name,
control.mother_last_name,
control.father_first_name,
control.father_last_name,
control.first_name,
control.middle_name,
control.last_name,
mdy_or_nil(control.dob),
control.sex,
control.vital_status.key,
control.do_not_contact,
enrollment.try(:is_eligible),
enrollment.try(:consented),
"TODO interview_assignment.notes_for_interviewer",
control.languages.first.try(:description),
address.try(:street),
address.try(:unit),
address.try(:city),
address.try(:state),
address.try(:zip),
address.try(:county),
nil,
nil
].to_csv.html_safe -%>
<% end -%>
<%#

I added html_safe to stop any html encoding just in case

-%>
